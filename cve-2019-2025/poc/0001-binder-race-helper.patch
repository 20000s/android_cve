From 3f23713ce3ab2e85d04b8111eaf74be5505fc1cb Mon Sep 17 00:00:00 2001
From: Jann Horn <jannh@google.com>
Date: Fri, 23 Nov 2018 19:37:06 +0100
Subject: [PATCH] binder race helper

---
 drivers/android/binder.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/drivers/android/binder.c b/drivers/android/binder.c
index cb30a524d16d..829c3734925b 100644
--- a/drivers/android/binder.c
+++ b/drivers/android/binder.c
@@ -72,6 +72,7 @@
 #include <linux/spinlock.h>
 #include <linux/ratelimit.h>
 #include <linux/syscalls.h>
+#include <linux/delay.h>
 
 #include <uapi/linux/android/binder.h>
 
@@ -2974,6 +2975,12 @@ static void binder_transaction(struct binder_proc *proc,
 		t->buffer = NULL;
 		goto err_binder_alloc_buf_failed;
 	}
+	pr_warn("[%d] ENTERING SLEEP BEFORE ZEROING allow_user_free (data{user}=0x%016lx allow_user_free=%u free_in_progress=%u free=%u)\n",
+		current->pid, (unsigned long)t->buffer->data + target_proc->alloc.user_buffer_offset,
+		t->buffer->allow_user_free, t->buffer->free_in_progress, t->buffer->free);
+	msleep(10000);
+	pr_warn("[%d] LEAVING SLEEP BEFORE ZEROING allow_user_free (allow_user_free=%u free_in_progress=%u free=%u)\n",
+		current->pid, t->buffer->allow_user_free, t->buffer->free_in_progress, t->buffer->free);
 	t->buffer->allow_user_free = 0;
 	t->buffer->debug_id = t->debug_id;
 	t->buffer->transaction = t;
-- 
2.20.0.rc0.387.gc7a69e6b6c-goog

